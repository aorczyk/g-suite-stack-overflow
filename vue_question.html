<script>
var compQuestion = Vue.component('question', {
    props: ['questionId', 'selectedId'],
    data() {
      return {
        sharedState: store.state,
        editorOption: quillSettings,
        newAnswerData: {
          text: ''
        },
        addNewCommentParentId: null,
        newCommentData: {
          text: ''
        },
        saving: false,
        editItem: null,
        editItemTmp: null,
      }
    },
    created() {
      console.log('question');
      console.log('questionId', this.questionId);
      console.log('sharedState.user', this.sharedState.user);
    },
    mounted() {
      // Show given entry

    },
    computed: {
      selectedQuestion() {
        if (this.sharedState.forum){
          var out = this.sharedState.forum.questions.filter((x) => {
            return x.id == this.questionId;
          });

          if (out.length) {
            setTimeout(()=>{
            if (this.selectedId) {
              this.$refs['foo'].click();
            }
            }, 200)
            return out[0];
          }
        }
        
        return;
      },
      sortedAnswers() {
          var items = this.sharedState.forum.answers[this.selectedQuestion.id];
          items.sort(function (a, b) {
            var aKey = a.vote;
            var bKey = b.vote;
            return (aKey > bKey) ? -1 : (aKey < bKey) ? 1 : 0;
          });

          return items;
        },
    },
    methods: {
        showQuestions() {
          this.pageId = 'questions';
          router.push(`/f/${this.sharedState.forum.id}`);
        },
        showAddNewComment(id) {
          if (this.addNewCommentParentId == id) {
            this.addNewCommentParentId = null;
          } else {
            this.addNewCommentParentId = id;
            this.newCommentData = {
              text: ''
            };

            var refId = 'comment_' + id;

            this.$nextTick(() => {
              if (Array.isArray(this.$refs[refId])) {
                this.$refs[refId][0].focus()
              } else {
                this.$refs[refId].focus()
              }
            })
          }
        },
        cancelAddNewComment() {
          this.addNewCommentParentId = null;
        },
        addComment() {
          var self = this;

          var data = {
            forumId: this.sharedState.forum.id,
            qId: this.selectedQuestion.id,
            aId: this.addNewCommentParentId,
            text: this.newCommentData.text,
          };

          this.saving = true;
          google.script.run.withSuccessHandler(function (data) {
            console.log(data);
            if (!self.sharedState.forum.comments[self.addNewCommentParentId]) {
              self.sharedState.forum.comments[self.addNewCommentParentId] = [];
            }
            self.sharedState.forum.comments[self.addNewCommentParentId].push(data);
            self.addNewCommentParentId = null;
            self.saving = false;
            self.sharedState.forum.lastChange[self.selectedQuestion.id] = data.time;

            var notificationData = {
              forumId: self.sharedState.forum.id,
              forumName: self.sharedState.forum.name,
              userId: self.selectedQuestion.userId,
              qId: data.qId,
              sId: data.id
            };

            google.script.run.withSuccessHandler()
            .withFailureHandler(function (e) {
              console.log('error');
              console.log(e.message);
            })
            .forumAddEntryNotification('comment', notificationData)
          }).withFailureHandler(function (e) {
            console.log('error');
            console.log(e.message);
            self.saving = false;
          }).forumAddEntry('comment', data);
        },
        addAnswer() {
          var self = this;

          var data = {
            forumId: this.sharedState.forum.id,
            qId: this.selectedQuestion.id,
            text: this.newAnswerData.text
          };

          if (data.text === '') {
            console.log('Empty answer!');
            return;
          }

          this.saving = true;
          google.script.run.withSuccessHandler(function (data) {
            if (!self.sharedState.forum.answers[self.selectedQuestion.id]) {
              self.sharedState.forum.answers[self.selectedQuestion.id] = [];
            }
            self.sharedState.forum.answers[self.selectedQuestion.id].push(data);
            self.sharedState.forum.comments[data.id] = [];

            self.newAnswerData.text = '';
            self.saving = false;
            self.sharedState.forum.lastChange[self.selectedQuestion.id] = data.time;

            var notificationData = {
              forumId: self.sharedState.forum.id,
              forumName: self.sharedState.forum.name,
              userId: self.selectedQuestion.userId,
              qId: data.qId,
              sId: data.id
            };

            google.script.run
            .withSuccessHandler()
            .withFailureHandler(function (e) {
              console.log('error');
              console.log(e.message);
            }).forumAddEntryNotification('answer', notificationData)
          }).withFailureHandler(function (e) {
            console.log('error');
            console.log(e.message);
            self.saving = false;
          }).forumAddEntry('answer', data);
        },
        vote(item, value) {
          var self = this;

          if (!this.canVote(item)) {
            return;
          }

          Vue.set(item, 'vote', item.vote + value);
          item.votedBy.push(self.sharedState.user.email);

          google.script.run.withSuccessHandler()
            .withFailureHandler(function (e) {
              console.log('error');
              console.log(e);
              self.saving = false;
            }).forumVote(this.sharedState.forum.id, item.id, value);
        },
        canVote(item) {
          if (item.userId == this.sharedState.user.email || item.votedBy.indexOf(this.sharedState.user.email) != -1) {
            return false;
          }

          return true;
        },
        bestAns(item) {
          Vue.set(this.sharedState.forum.bestAns, this.selectedQuestion.id, item.id);
          // this.sharedState.forum.bestAns[this.selectedQuestion.id] = item.id;

          google.script.run.withSuccessHandler()
            .withFailureHandler(function (e) {
              console.log('error');
              console.log(e);
            }).forumBestAns(this.sharedState.forum.id, item.id);
        },
        editOpen(item) {
          this.editItem = item;
          this.editItemTmp = JSON.parse(JSON.stringify(item));
        },
        editSave() {
          var self = this;
          this.saving = true;
          console.log(this.editItem);
          google.script.run.withSuccessHandler(function (item) {
              Vue.set(self.editItem, 'edited', item.edited);
              Vue.set(self.editItem, 'status', item.status);
              if (item.status == 'Deleted'){
                self.editItem.body = self.editItemTmp.body;
              }
              self.editItem = null;
              self.editItemTmp = null;
              self.saving = false;
            })
            .withFailureHandler(function (e) {
              console.log('error');
              console.log(e.message);
              self.saving = false;
            }).editSave(this.editItem);
        },
        editClose() {
          this.editItem.body = this.editItemTmp.body;
          this.editItem = null;
        },
        newRef(p1, p2){
          return String(p1) + String(p2);
        },
        getItemLink(item){
          return `${this.sharedState.forum.appUrl}#/f/${this.sharedState.forum.id}/q/${this.questionId}/${item.id}`;
        }
    },
    template:
    `
    <div>
      <a :href="'#' + selectedId" ref="foo"></a>
      
      <div class="modal" :class="{'is-active': editItem}">
        <div class="modal-background"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">Edit</p>
          </header>
          <section class="modal-card-body">
            <div class="field">
              <div class="control" v-if="editItem">
                <quill-editor v-model="editItem.body" ref="quillEditorA" :options="editorOption"
                  v-if="editItem.type !== 'comment'"></quill-editor>
                <input class="input" type="text" v-model="editItem.body" v-else>
              </div>
            </div>
          </section>
          <footer class="modal-card-foot">
            <div class="field is-grouped">
              <div class="control">
                <button class="button is-info" :class="{'is-loading': saving}" @click="editSave">Save</button>
              </div>
              <div class="control">
                <button class="button" @click="editClose" :disabled="saving">Cancel</button>
              </div>
            </div>
          </footer>
        </div>
      </div>
    
      <div class="forum-page" if="sharedState.forum">
        <div class="container forum-ans" v-if="selectedQuestion">
          <div class="field">
            <div class="button is-info" @click="showQuestions">Back To Questions</div>
          </div>
          <div class="forum-ans-title">{{ selectedQuestion.title }}</div>
          <div class="forum-ans-list">
            <div class="forum-ans-row forum-ans-question">
              <div class="forum-ans-row-left">
                <div class="forum-ans-row-left-vote" @click="vote(selectedQuestion, 1)"
                    :class="{'forum-ans-row-left-vote-disabled': !canVote(selectedQuestion)}">
                  <i class="fas fa-caret-up" title="Pytanie jest przydatne"></i>
                </div>
                <div class="forum-ans-row-left-vote-value">
                  {{ selectedQuestion.vote }}
                </div>
                <div class="forum-ans-row-left-vote" @click="vote(selectedQuestion, -1)"
                    :class="{'forum-ans-row-left-vote-disabled': !canVote(selectedQuestion)}">
                  <i class="fas fa-caret-down" title="Pytanie nie jest przydatne"></i>
                </div>
              </div>
              <div class="forum-ans-row-content">
                <div v-html="selectedQuestion.body"></div>
                <div class="forum-ans-row-content-info">
                  <edit-icon :item="selectedQuestion" @edit="editOpen"></edit-icon>
                </div>
                <div class="forum-ans-comments">
                  <div class="forum-ans-comments-list">
                    <div class="forum-ans-comments-list-row" :class="{'forum-selected-item': comment.id == selectedId}"
                      v-for="comment in sharedState.forum.comments[selectedQuestion.id]">
                      <span></span>{{ comment.body }} - </span>
                      <edit-icon :item="comment" @edit="editOpen"></edit-icon>
                      <a class="action-icon" :href="getItemLink(comment)" target="blank"><i class="fas fa-external-link-alt"></i></a>
                    </div>
                  </div>
                  <div>
                    <span class="forum-ans-comments-add" @click="showAddNewComment(selectedQuestion.id)"
                      v-if="!sharedState.forum.am.isClosed">add a comment</span>
                  </div>
                  <div class="forum-ans-comments-new" v-show="addNewCommentParentId == selectedQuestion.id">
                    <div class="field">
                      <div class="control">
                        <input class="input" type="text" v-model="newCommentData.text" :ref="newRef('comment_',selectedQuestion.id)">
                      </div>
                    </div>
                    <div class="field is-grouped">
                      <div class="control">
                        <button class="button is-info" :class="{'is-loading': saving}" @click="addComment"
                          :disabled="saving">Save</button>
                      </div>
                      <div class="control">
                        <button class="button" @click="cancelAddNewComment" :disabled="saving">Cancel</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="forum-ans-separator">{{ sharedState.forum.answers[selectedQuestion.id] ? sharedState.forum.answers[selectedQuestion.id].length : 0 }} Answers</div>
          <div class="forum-ans-list">
            <div class="forum-ans-row" :id="ans.id" :class="{'forum-selected-item': ans.id == selectedId}"
              v-for="ans in sortedAnswers">
              <div class="forum-ans-row-left">
                <div class="forum-ans-row-left-vote" @click="vote(ans, 1)"
                :class="{'forum-ans-row-left-vote-disabled': !canVote(ans)}">
                  <i class="fas fa-caret-up"
                  title="Odpowiedź jest przydatna"></i>
                </div>
                <div class="forum-ans-row-left-vote-value">
                  {{ ans.vote }}
                </div>
                <div class="forum-ans-row-left-vote" @click="vote(ans, -1)"
                :class="{'forum-ans-row-left-vote-disabled': !canVote(ans)}">
                  <i class="fas fa-caret-down"
                  title="Odpowiedź nie jest przydatna"></i>
                </div>
                <div class="forum-ans-row-left-bestAns" v-if="!sharedState.forum.bestAns[selectedQuestion.id] && sharedState.user.email == selectedQuestion.userId" @click="bestAns(ans)">
                  <i class="fas fa-check"></i>
                </div>
                <div class="forum-ans-row-left-bestAns-selected" v-if="sharedState.forum.bestAns[selectedQuestion.id] && sharedState.forum.bestAns[selectedQuestion.id] == ans.id">
                  <i class="fas fa-check" title="Zadający pytanie uważa, że ta odpowiedź jest najlepsza"></i>
                </div>
              </div>
              <div class="forum-ans-row-content">
                <div v-html="ans.body"></div>
                <div class="forum-ans-row-content-info">
                  <edit-icon :item="ans" @edit="editOpen"></edit-icon>
                  <a class="action-icon" :href="getItemLink(ans)" target="blank"><i class="fas fa-external-link-alt"></i></a>
                </div>
                <div class="forum-ans-comments">
                  <div class="forum-ans-comments-list">
                    <div class="forum-ans-comments-list-row" :id="comment.id"
                      :class="{'forum-selected-item': comment.id == selectedId}"
                      v-for="comment in sharedState.forum.comments[ans.id]">
                      <span></span>{{ comment.body }} - </span>
                      <edit-icon :item="comment" @edit="editOpen"></edit-icon>
                      <a class="action-icon" :href="getItemLink(comment)" target="blank"><i class="fas fa-external-link-alt"></i></a>
                    </div>
                  </div>
                  <div>
                    <span class="forum-ans-comments-add" @click="showAddNewComment(ans.id)" v-if="!sharedState.forum.am.isClosed">add a comment</span>
                  </div>
                  <div class="forum-ans-comments-new" v-show="addNewCommentParentId == ans.id">
                    <div class="field">
                      <div class="control">
                        <input class="input" type="text" v-model="newCommentData.text" :ref="newRef('comment_',ans.id)">
                      </div>
                    </div>
                    <div class="field is-grouped">
                      <div class="control">
                        <button class="button is-info" :class="{'is-loading': saving}" @click="addComment"
                          :disabled="saving">Save</button>
                      </div>
                      <div class="control">
                        <button class="button" @click="cancelAddNewComment" :disabled="saving">Cancel</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div v-if="!sharedState.forum.am.isClosed">
            <div class="forum-ans-text">Your Answer</div>
            <quill-editor v-model="newAnswerData.text" ref="quillEditorA" :options="editorOption">
            </quill-editor>
            <div class="forum-ans-add">
              <div class="button is-info" :class="{'is-loading': saving}" @click="addAnswer" :disabled="saving">Post Your Answer</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    `
});
</script>