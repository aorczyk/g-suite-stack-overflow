<script>
  var store = {
    state: {
      user: dataFromServer.user,
      forum: null,
      isSpinnerVisible: false,
      searched: null,
      searchText: '',
      searchVisible: true,
      forumsButtonVisible: true,
      newTopicFormVisible: false,
      newForumFormVisible: false,
      editForum: null,
      logoImg: dataFromServer.logoImg
    },
    setForum(newValue) {
      this.state.forum = newValue
    },
    search(){
      if (!this.state.searchText){
        this.state.searched = null;
        return;
      }

      var reg = new RegExp(this.state.searchText, 'i');
      this.state.isSpinnerVisible = true;

      this.state.searched = this.state.forum.questions.filter((x)=>{
        return x.title.search(reg) != -1 || x.body.search(reg) != -1;
      }).map((x)=>{return x.id});

      for (var entity of ['answers', 'comments']){
        for (var id in this.state.forum[entity]){
          for (var item of this.state.forum[entity][id]){
            if (item.body && item.body.search(reg) != -1){
              this.state.searched.push(item.qId);
            }
          }
        }
      }

      this.state.isSpinnerVisible = false;

      if (router.currentRoute.path != `/${this.state.forum.id}`){
        router.push(`/${this.state.forum.id}`);
      }
    },
    clearSearch() {
      this.state.searchText = '';
      Vue.set(this.state, 'searched', null);
    },
    highlight(string){
      var out = string;

      if (this.state.searchText && this.state.searched){
        const regex = />([^><]*?)</gi;
        const regexSearch = new RegExp(this.state.searchText, 'ig');

        var match = regex.exec(string);

        while (match != null) {
          let outPart = '>' + match[1].replace(regexSearch, '<span class="highlight">$&</span>') + '<';

          if (outPart){
            out = out.replace(match[0], outPart);
          }

          match = regex.exec(string);
        }
      }
      return out;
    },
    highlightText(string){
      var out = string;

      if (this.state.searchText && this.state.searched){
        const regexSearch = new RegExp(this.state.searchText, 'ig');

        out = string.replace(regexSearch, '<span class="highlight">$&</span>');
      }

      return out;
    }
  };
</script>