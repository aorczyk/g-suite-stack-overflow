<script>
  var store = {
    debug: true,
    state: {
      user: dataFromServer.user,
      forum: null,
      isSpinnerVisible: false,
      searched: null,
      searchText: '',
      searchVisible: true,
      forumsButtonVisible: true,
    },
    setForum(newValue) {
      if (this.debug) console.log('setForum triggered with', newValue)
      this.state.forum = newValue
    },
    search(){
      if (!this.state.searchText){
        this.state.searched = null;
      }

      var reg = new RegExp(this.state.searchText, 'i');
      this.state.isSpinnerVisible = true;

      this.state.searched = this.state.forum.questions.filter((x)=>{
        return x.title.search(reg) != -1 || x.body.search(reg) != -1;
      }).map((x)=>{return x.id});

      for (var entity of ['answers', 'comments']){
        for (var id in this.state.forum[entity]){
          for (var item of this.state.forum[entity][id]){
            if (item.body && item.body.search(reg) != -1){
              this.state.searched.push(item.qId);
            }
          }
        }
      }

      this.state.isSpinnerVisible = false;

      if (router.currentRoute.path != `/${this.state.forum.id}`){
        router.push(`/${this.state.forum.id}`);
      }
    },
    clearSearch() {
      this.state.searchText = '';
      // this.search();
      Vue.set(this.state, 'searched', null);
    },
    highlight(html){
      var out = html;

      // if (this.state.searchText && this.state.searched){
      //   var reg = new RegExp('(?<=>)([\w\s]*)' + this.state.searchText + '([\w\s]*)(?=<\/)', 'ig');

      //   if (html.match(reg)){
      //     out = html.replace(reg, '<span class="highlight">$&</span>');
      //   }
      // }

      return out;
    }
  };
</script>